<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tracing MinIO and rust-statemap - Kody&#x27;s Blog</title>
        <!-- Custom HTML head -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-90522412-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-90522412-1');
</script>        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "rust" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../welcome.html">Welcome</a></li><li class="chapter-item expanded affix "><a href="../2022/tech_debt.html">Enjoying technical debt</a></li><li class="chapter-item expanded affix "><a href="../2021/rust-statemap.html">Statemap library for Rust programs</a></li><li class="chapter-item expanded affix "><a href="../2021/cluster_simulator.html">Cluster Simulator</a></li><li class="chapter-item expanded affix "><a href="../2020/minio_tracing.html" class="active">Tracing MinIO and rust-statemap</a></li><li class="chapter-item expanded affix "><a href="../2020/ctp_theorem.html">CTP Theorem for Happiness at Work</a></li><li class="chapter-item expanded affix "><a href="../2020/monolithic_applications.html">Monolithic Applications</a></li><li class="chapter-item expanded affix "><a href="../2019/zfs_recordsize.html">ZFS Recordsize</a></li><li class="chapter-item expanded affix "><a href="../2019/pg_temp_files.html">Postgres Temporary Files</a></li><li class="chapter-item expanded affix "><a href="../2019/hw_raid_eating_data.html">Hardware RAID is lying to you</a></li><li class="chapter-item expanded affix "><a href="../2018/pg_xlogdump.html">pg_xlogdump(1) - a tale of 15 round trips</a></li><li class="chapter-item expanded affix "><a href="../2017/android_cr.html">Android Checkpoint / Restore</a></li><li class="chapter-item expanded affix "><a href="../2017/dockerbox.html">Dockerbox - Virtual Filesystem</a></li><li class="chapter-item expanded affix "><a href="../2017/two_in_bush.html">Worth Two in the Bush</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Kody&#x27;s Blog</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="tracing-minio-and-rust-statemap"><a class="header" href="#tracing-minio-and-rust-statemap">Tracing MinIO and rust-statemap</a></h1>
<h4 id="2020-06-02"><a class="header" href="#2020-06-02">2020-06-02</a></h4>
<p>MinIO is a neat little program. I initially thought that MinIO was just a broker
that could provide an S3 API to front another object storage system.
However, MinIO can do a lot more than this.</p>
<p>There are currently two interesting modes of operation for MinIO. The first is
as a gateway, which acts like I described previously. It layers an S3 API on top
of another object storage system. The 'backend' system could be Manta, Google
Cloud Storage, Azure Blob Storage, S3 itself, or any other system. You could
even implement a WebDAV backend or local filesystem backend if you wanted to.</p>
<p>The second interesting mode of operation has MinIO act as a distributed object
storage system. MinIO itself is the backend storage in this model. MinIO can use
erasure coding to store files in a durable and inexpensive manner across
multiple machines, possibly in different availability zones.</p>
<p>We were considering using MinIO as the storage tier for Manta to reduce the cost
of storing data while maintaining acceptable durability characteristics. This
would have been an alternative to an iSCSI + ZFS layered architecture. Details
are described in
<a href="https://github.com/joyent/rfd/blob/master/rfd/0181/README.md">RFD-181</a>.
Other software companies also use MinIO as part of their larger object
storage systems. Nutanix is one of the more recent groups to announce they are
using MinIO in their system.</p>
<p>Although we ended up not choosing to pursue MinIO we did learn a lot about it
along the way. We also wrote and extended a couple pretty cool tools to help
us use MinIO. I'll describe these here.</p>
<h3 id="chum"><a class="header" href="#chum">Chum</a></h3>
<p>I wrote about
<a href="https://blog.kkantor.com/2020/storage_tier_improvements">manta-chum in the past</a>.
It's a tool that we wrote to test the Manta storage
tier when we found existing tools like fio and COSbench were insufficient.</p>
<p>We extended manta-chum to support the S3 protocol. Unfortunately the S3 protocol
is heavy even from the perspective of a client, so we chose to use a heavy Rust
AWS API library rather than writing our own minimal client.</p>
<p>Using manta-chum with MinIO allowed us to use the same tool to benchmark all of
our possible storage tier configurations using the same software. This is really
important to us so that we know that the load gen tool is following the same
logic across all target configurations. Plus, manta-chum has tabular output and
we already had a number of gnuplot knowledge we could transfer from the local
filesystem and WebDAV testing we performed earlier.</p>
<p>The new mode can be invoked like this:</p>
<pre><code>$ ./chum -t s3:localhost -w r,w,d -s 10
</code></pre>
<p>See the repo for more information.</p>
<h3 id="minio-trace-data"><a class="header" href="#minio-trace-data">MinIO trace data</a></h3>
<p>When we started looking at MinIO we found some performance problems. Latency was
high and we weren't sure why. We were wondering what each MinIO instance was
doing at any given time. Luckily we discovered MinIO's tracing utilities.</p>
<p>MinIO has a pretty nice distributed tracing facility built-in. Although the data
is nice, it's impossible to consume without additional tools. Here's what the
data looks like, in JSON form:</p>
<pre><code>$ mc admin trace -a --json min0 | tee my_trace
[...]
{
 &quot;host&quot;: &quot;localhost:9000&quot;,
 &quot;time&quot;: &quot;2020-06-02T16:12:29.745192997Z&quot;,
 &quot;client&quot;: &quot;172.19.0.1&quot;,
 &quot;callStats&quot;: {
  &quot;rx&quot;: 262234,
  &quot;tx&quot;: 263,
  &quot;duration&quot;: 39692427,
  &quot;timeToFirstByte&quot;: 0
 },
 &quot;api&quot;: &quot;s3.PutObject&quot;,
 &quot;path&quot;: &quot;/chum/v2/chum/ae/ae8ae9bf-9785-4fdf-bb62-abdd7e60f377&quot;,
 &quot;query&quot;: &quot;&quot;,
 &quot;statusCode&quot;: 200,
 &quot;statusMsg&quot;: &quot;OK&quot;
}
</code></pre>
<p>That snippet shows a top-level operation, <code>s3.PutObject</code>. We also get
trace data for each individual internal cluster API operation, like when one
node tells another node to create or delete a file.</p>
<h3 id="minio-statemap"><a class="header" href="#minio-statemap">minio-statemap</a></h3>
<p>I really enjoy using the statemap tool that Bryan wrote when he was at Joyent.
We decided to write some software to convert the MinIO trace data to the
statemap input format so we can generate statemaps of a MinIO cluster. This
seemed like pretty novel stuff at the time since to date most of our statemap
data sources have been DTrace scripts.</p>
<p><a href="https://github.com/joyent/minio-statemap">minio-statemap</a> was born!
This tool takes the above trace data and converts it into per-node states that
look like this:</p>
<pre><code>$ ./minio-statemap -i ./my_trace -c &quot;blog cluster&quot; &gt; minio_states
[...]
{&quot;time&quot;:&quot;147181850&quot;,&quot;entity&quot;:&quot;localhost:9000&quot;,&quot;state&quot;:10,&quot;tag&quot;:null}
</code></pre>
<p>Creating statemap metadata and ensuring an entity doesn't 'go back in time' is
also handled.</p>
<p>Now we can generate a statemap using the usual statemap workflow:</p>
<pre><code>$ statemap minio_states &gt; minio.svg
</code></pre>
<h3 id="rust-statemap"><a class="header" href="#rust-statemap">rust-statemap</a></h3>
<p>After hacking together minio-statemap it was abundantly clear that we needed a
convenient wrapper for the statemap API. Manually setting up statemap
structs and ensuring all of the statemap rules were followed was very messy.</p>
<p>We wrote a rust module that helps developers create statemaps. This can be used
out-of-band like we did with minio-statemap, or in the hot path. We use the
hot-path method in manta-chum, which I may write about later.</p>
<p>Regardless, <a href="https://github.com/kodykantor/rust-statemap">rust-statemap</a> was
built to provide a simple API for creating statemaps. In my opinion
this should be moved into the statemap repository instead of being maintained
as a separate tool. Some explanation of my thoughts on this are at the end
of the README.</p>
<p>After we had rust-statemap we were able to refactor minio-statemap to remove
all of this confusing logic.</p>
<h3 id="results"><a class="header" href="#results">Results</a></h3>
<p>At the end of the day we get a statemap that looks like this:</p>
<p><img src="assets/full.png" alt="zoomed-out minio statemap" /></p>
<p>We can zoom in and see the exact internal API calls that make up each top-level
API call. This will also show us how long each API call takes and how much time
is wasted between calls.</p>
<p><img src="assets/zoomed.png" alt="zoomed-in minio statemap" /></p>
<p>This tool has been incredibly helpful for us. Using minio-statemap we were able
to trim out a lot of unnecessary work from the extremely chatty MinIO protocol.</p>
<p>A full MinIO statemap SVG can be found in the <a href="https://github.com/joyent/minio-statemap/tree/master/examples">minio-statemap repository</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../2021/cluster_simulator.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../2020/ctp_theorem.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../2021/cluster_simulator.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../2020/ctp_theorem.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
