<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hardware RAID is lying to you - Kody&#x27;s Blog</title>
        <!-- Custom HTML head -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-90522412-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-90522412-1');
</script>        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "rust" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../welcome.html">Welcome</a></li><li class="chapter-item expanded affix "><a href="../2022/tech_debt.html">Enjoying technical debt</a></li><li class="chapter-item expanded affix "><a href="../2021/rust-statemap.html">Statemap library for Rust programs</a></li><li class="chapter-item expanded affix "><a href="../2021/cluster_simulator.html">Cluster Simulator</a></li><li class="chapter-item expanded affix "><a href="../2020/minio_tracing.html">Tracing MinIO and rust-statemap</a></li><li class="chapter-item expanded affix "><a href="../2020/ctp_theorem.html">CTP Theorem for Happiness at Work</a></li><li class="chapter-item expanded affix "><a href="../2020/monolithic_applications.html">Monolithic Applications</a></li><li class="chapter-item expanded affix "><a href="../2019/zfs_recordsize.html">ZFS Recordsize</a></li><li class="chapter-item expanded affix "><a href="../2019/pg_temp_files.html">Postgres Temporary Files</a></li><li class="chapter-item expanded affix "><a href="../2019/hw_raid_eating_data.html" class="active">Hardware RAID is lying to you</a></li><li class="chapter-item expanded affix "><a href="../2018/pg_xlogdump.html">pg_xlogdump(1) - a tale of 15 round trips</a></li><li class="chapter-item expanded affix "><a href="../2017/android_cr.html">Android Checkpoint / Restore</a></li><li class="chapter-item expanded affix "><a href="../2017/dockerbox.html">Dockerbox - Virtual Filesystem</a></li><li class="chapter-item expanded affix "><a href="../2017/two_in_bush.html">Worth Two in the Bush</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Kody&#x27;s Blog</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="hardware-raid-is-lying-to-you"><a class="header" href="#hardware-raid-is-lying-to-you">Hardware RAID is Lying to You</a></h1>
<h4 id="2019-03-08"><a class="header" href="#2019-03-08">2019-03-08</a></h4>
<p>We were migrating a large ZFS filesystem (11.4T logical) from one machine to
another. I was warned ahead of time that the old system was <em>very</em> old:</p>
<ul>
<li>It was running the <code>20141030T081701Z</code> platform image.</li>
<li>uptime(1) states: <code>up 1521 day(s)</code> (wow!).</li>
<li>ZFS is sitting on top of hardware RAID.</li>
</ul>
<p>We haven't used this configuration in years:</p>
<pre><code>NAME STATE READ WRITE CKSUM
zones ONLINE 0 0 0
c0t0d0 ONLINE 0 0 0
</code></pre>
<p>The machine is running a version of ZFS so old that the spa doesn't have
'ashift' members, meaning it is difficult to accurately guess what the sector
size of the drives are assumed to be. Since this is so old we can probably
safely assume they are 512b sectors behind the RAID controller.</p>
<p>Anyway, the problem was that we had numerous 'zfs send | zfs receive' failures.
The reason for this was that the received dataset was going well over the
storage quota assigned to the dataset. The dataset was assigned a 15T quota and
has an 8K record size.</p>
<p>At first it seems strange that this would happen. Why would an 11.4T dataset hit
a 15T quota? Well, the folks running the dataset migration decided to turn off
the quota, thinking that it can't be <em>much</em> more than 15T. Maybe some extra data
is used when large datasets are transferred or something.</p>
<p>So a couple days later we realize that the migration is <em>still</em> running and the
dataset on the target machine is now 21T! WOW! That's almost double the size of
the original dataset!</p>
<p>What's all that extra data, where is it coming from, and what the hell
happened?!</p>
<p>What if I told you that this is a feature, and not a bug? Let's take a look at
the target system to figure out why.</p>
<ul>
<li>Running the 20181206T011455Z platform image.</li>
<li>uptime(1) states: up 53 day(s)</li>
<li>11-wide RAIDz2 with a SLOG device and one spare:</li>
</ul>
<pre><code>NAME STATE READ WRITE CKSUM
zones ONLINE 0 0 0
raidz2-0 ONLINE 0 0 0
c3t5000CCA25329A52Dd0 ONLINE 0 0 0
c3t5000CCA25330316Dd0 ONLINE 0 0 0
c3t5000CCA253306FEDd0 ONLINE 0 0 0
c3t5000CCA253361779d0 ONLINE 0 0 0
c3t5000CCA253380975d0 ONLINE 0 0 0
c3t5000CCA25346BA21d0 ONLINE 0 0 0
c3t5000CCA2534BC35Dd0 ONLINE 0 0 0
c3t5000CCA25353DC69d0 ONLINE 0 0 0
c3t5000CCA253543865d0 ONLINE 0 0 0
c3t5000CCA2535471B5d0 ONLINE 0 0 0
c3t5000CCA253556625d0 ONLINE 0 0 0
logs
c1t4d0 ONLINE 0 0 0
spares
c3t5000CCA253CBD0A5d0 AVAIL
</code></pre>
<p>This is a very new box. As far as I know we haven't deployed anything to it
previously. Its disks have 4K sectors.</p>
<p>Let's think about what happens when we write a block to ZFS on the old machine.</p>
<ul>
<li>The application writes an 8K block.</li>
<li>ZFS (in RAID0 mode) writes an 8K block.</li>
<li>Hardware RAID does magic junk that us mere mortals are not privy to.</li>
</ul>
<p>These magic things at least include writing parity blocks for
however the parity is configured. It's hard to tell what is
happening or how this is configured because it's all supposed to
be magical happiness and good times. We may even have to enter
into the BIOS to see what the RAID settings are (which would
mean ending the 4+ year uptime track record!).</p>
<ul>
<li>ZFS believes it wrote 8K of data both logically and physically.</li>
</ul>
<p>Now let's think about what happens when we write a block to ZFS on the new
machine.</p>
<ul>
<li>The application writes an 8K block.</li>
<li>ZFS (in RAIDz2 mode) writes an 8K block and two parity sectors (4K).</li>
<li>ZFS believes it wrote 8K of logical data and 16K of physical data.</li>
</ul>
<p>Do you see where the extra data is coming from now? It's the parity!</p>
<p>After we discovered this we let the transfer finish, and now the <em>logical</em>
dataset sizes match while the <em>physical</em> dataset size on the target machine is
double that of the source machine:</p>
<p>Source:</p>
<pre><code>zones/b7c55652-e7c8-46b0-9f57-fae90314caf5 used 11.7T
zones/b7c55652-e7c8-46b0-9f57-fae90314caf5 logicalused 11.6T
</code></pre>
<p>Target:</p>
<pre><code>zones/b7c55652-e7c8-46b0-9f57-fae90314caf5 used 26.6T
zones/b7c55652-e7c8-46b0-9f57-fae90314caf5 logicalused 11.6T
</code></pre>
<p>As I was looking into this I also noticed that we have lz4 compression turned
on, but it isn't doing anything other than increasing latency and burning CPU
time:</p>
<pre><code>zones/b7c55652-e7c8-46b0-9f57-fae90314caf5 compressratio 1.00x
zones/b7c55652-e7c8-46b0-9f57-fae90314caf5 compression lz4
</code></pre>
<p>I didn't quantify time wasted trying to compress data. It could be that the
application is doing compression before hitting ZFS, or the data being written
in incompressible.</p>
<p>We learned a few things from this:</p>
<ul>
<li>Hardware RAID hides information from advanced filesystems like ZFS.</li>
<li>Hardware RAID is difficult to debug and gather information about.</li>
<li>Hardware RAID makes it seem like you're using less storage capacity than you
truly are.</li>
<li>Using an 8K record size on RAIDz2 gives you 50% disk efficiency (although
you are given net more storage than disk mirroring due to decreased
durability).</li>
<li>Make sure ZFS compression is doing <em>something</em> if it's enabled.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../2019/pg_temp_files.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../2018/pg_xlogdump.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../2019/pg_temp_files.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../2018/pg_xlogdump.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
