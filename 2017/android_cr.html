<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Android Checkpoint / Restore - Kody&#x27;s Blog</title>
        <!-- Custom HTML head -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-90522412-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-90522412-1');
</script>        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "rust" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../welcome.html">Welcome</a></li><li class="chapter-item expanded affix "><a href="../2022/tech_debt.html">Enjoying technical debt</a></li><li class="chapter-item expanded affix "><a href="../2021/rust-statemap.html">Statemap library for Rust programs</a></li><li class="chapter-item expanded affix "><a href="../2021/cluster_simulator.html">Cluster Simulator</a></li><li class="chapter-item expanded affix "><a href="../2020/minio_tracing.html">Tracing MinIO and rust-statemap</a></li><li class="chapter-item expanded affix "><a href="../2020/ctp_theorem.html">CTP Theorem for Happiness at Work</a></li><li class="chapter-item expanded affix "><a href="../2020/monolithic_applications.html">Monolithic Applications</a></li><li class="chapter-item expanded affix "><a href="../2019/zfs_recordsize.html">ZFS Recordsize</a></li><li class="chapter-item expanded affix "><a href="../2019/pg_temp_files.html">Postgres Temporary Files</a></li><li class="chapter-item expanded affix "><a href="../2019/hw_raid_eating_data.html">Hardware RAID is lying to you</a></li><li class="chapter-item expanded affix "><a href="../2018/pg_xlogdump.html">pg_xlogdump(1) - a tale of 15 round trips</a></li><li class="chapter-item expanded affix "><a href="../2017/android_cr.html" class="active">Android Checkpoint / Restore</a></li><li class="chapter-item expanded affix "><a href="../2017/dockerbox.html">Dockerbox - Virtual Filesystem</a></li><li class="chapter-item expanded affix "><a href="../2017/two_in_bush.html">Worth Two in the Bush</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Kody&#x27;s Blog</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="android-checkpointrestore"><a class="header" href="#android-checkpointrestore">Android Checkpoint/Restore</a></h1>
<h4 id="2017-02-01"><a class="header" href="#2017-02-01">2017-02-01</a></h4>
<p>I got my first computer in 2004 for Christmas. It was some kind of Dell tower
with an awesome flat screen LCD display! It was given to me in the evening, but
for some reason I couldn't set it up immediately and I had to wait until the
morning. When the morning came I got up, and in a flurry of excitement pulled
all of the parts out of the box and put it all together. It had a single core
Pentium IV processor, and a whopping 128MB of RAM, integrated graphics, and a
killer DVD drive. When I had it all put together I clicked the power button and
heard the fans start up. The lights on the tower came on, but nothing appeared
on the screen. I double checked that the screen was turned on, and hard-reset
the tower. Same thing. I think I stared at the blank flat screen monitor for a
solid ten minutes before giving up.</p>
<p>I went to find my dad to help me figure out why the darn thing wasn't working.
It turns out that I had neglected to connect the monitor to the tower! A silly
mistake that only a fifth grader would make!</p>
<p>After a while my brother (who had an identical computer) decided to get a
different computer, so I took the RAM out of his and stuck it in mine. Math
lovers will note that I now had 256MB of RAM. I thought that was a lot back
then! In 2011 I bought parts to put together a computer, and bought 16GB of RAM
for something like 20 bucks. Now my phone has 2GB of RAM, and it seems like
it's always starved for memory.</p>
<p>Android, Windows Phone (if that's still a thing), and iOS are all used pretty
much the same way. You can run one application in the foreground at any given
time, and the rest of your applications idle in the background, or are killed if
the system is starved for RAM. For me, it seems like applications are constantly
being killed to provide RAM for the process in the foreground. This makes
multitasking really cumbersome and difficult. As a result of the apps being
killed, I have to wait while they reload when I open them, and all of my session
state is missing. Is there any way to solve this problem?</p>
<p>One of the things that I was involved in recently was working with some interns
on implementing live migration of bare-metal processes across machines. We used
a Linux tool called
<a href="https://criu.org/Main_Page">CRIU</a> (checkpoint/restore in userspace)
which has the ability to checkpoint and restore processes. Even though it's
called '...in userspace,' it has required a number of changes to the Linux
kernel, like enabling the kernel to track process memory changes, and a
fork_with_pid() function that requests a specific PID to be used for the new
process. They're also considering changing the way <code>/proc</code> is designed. <code>/proc</code>
is used very heavily during the C/R process, so the overhead of opening/closing
all of those files is quite large. In the case of live migration, any slowdown
in CRIU represents an increase in the application downtime, which is not good.</p>
<p>Most people think that C/R is only useful for live migration. That's definitely
not the case! When I was thinking about my phone's RAM problem, I
thought that it could be an interesting use case for C/R! Android runs on a
modified Linux kernel, so it may have the ability to run CRIU assuming the
Android maintainers are merging from upstream (which I believe they are).</p>
<p>The question is, what can we do with C/R in Android? Let's say that I just woke
up. I like to read the news, check my email, check my calendar, and then
maybe play a game (nothing like being lazy to start the day!). Maybe I
get a Snapchat notification while I'm playing this game. I switch to the
Snapchat application, reply to the snap, and then switch back to my game. When I
switch back to my game I have to completely restart because it was killed!
Snapchat uses most of the RAM on my device, and so does the game! I'm
frustrated now, so I switch back to Snapchat. It turns out that Snapchat was
killed while my game was starting! AHHHH! They can't both be in memory, so now
I have this vicious cycle of frustration.</p>
<p>C/R to the rescue? What if we could checkpoint an application (that we know uses
a lot of RAM) when it is taken out of the foreground? Then we don't need to
worry if it gets killed. All of the state (including registers, TCP connections,
memory, etc.) is on the internal storage. We can use Snapchat all that we want.
When we need to go back to our game, the system issues a restore from storage.
All of the pages are mapped back into memory, and we're off to the races! The
game is EXACTLY where we left it. While we're playing the game, Snapchat is
checkpointed so we can return to that without having to wait through the
agonizing startup routines again.</p>
<p>Now let's say that I was in the middle of beating a boss on my video game when
I get a phone call. The phone call forces my game to be checkpointed and killed.
Maybe the phone call was a nasty hacker and they used some weird key tone that
causes my phone to reboot. Damn it! I was JUST BEATING A BOSS. My phone reboots,
memory is wiped, and I frantically open the game. Luckily, the game was just
checkpointed, so it was restored to the point before I got the malicious phone
call! When I open up the game, I'm right back to where I was: in the middle of
an epic boss fight.</p>
<p>There are a ton of problems with thinking this will work. TCP connections (if
any - I'm not sure that mobile apps maintain long TCP connections) will probably
be dropped by the server in the time between checkpoint and restore. Android is
hella fragmented, and that fragmentation goes all the way down to the kernel.
I'm pretty sure manufacturers NEVER update the kernel on their devices. So any
changes to fix or enhance the kernel features of CRIU would probably never be
sent out to phones.</p>
<p>Luckily mobile applications don't use much memory, so we shouldn't have to worry
about copying many GBs of memory to storage when a checkpoint occurs. However,
phones also don't usually have much extra storage. Another problem would be the
power usage. I'm guessing dumping memory isn't the most efficient of tasks.</p>
<p>There are some cool things about this. Applications could use more memory
without impacting other applications. Applications persist state across reboots.
This approach is pretty much only viable as a thought exercise because mobile
users only interact with one application at a time.</p>
<p>Even though it isn't more than a thought, it's still fun to think about the use
cases of C/R on Android.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../2018/pg_xlogdump.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../2017/dockerbox.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../2018/pg_xlogdump.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../2017/dockerbox.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
